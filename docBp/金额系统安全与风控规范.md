

金额系统安全与风控规范.md

# 所有接口需要幂等
# 数据存储使用bigDecmber
# 扣款时候注意余额校验不为0
# 使用预下单模式 不要直接转账模式，

扣款使用预下单模式（校验密码、校验余额）
生成一个单子，里面freeAmt增加

所有资金相关接口，加上幂等控制（避免重复扣款
*  推荐前端传入 idempotencyKey  ,幂等控制   接口加全局幂等锁（可选）
# 基本的事务控制  必须数据库事务
# 悲观锁 使用 SELECT ... FOR UPDATE 方式锁住这笔订单记录



# 枚举合法转移状态，确保  PENDING → BOOKED 

# 把“设置状态为 BOOKED”放在加钱后面，或者加钱成功之后再设置状态。

* addMoneyToWltService1 也要幂等


# 3. 交易状态严控（状态机）  不能跳过状态。禁止重复设置状态
   明确所有状态转移路径：

text
复制
编辑
CREATED → PENDING → BOOKED
→ FAILED
不能跳过状态。例如：

禁止 CREATED → BOOKED 直接跳转

禁止重复设置 BOOKED → BOOKED


1. 金额精度与格式
   所有金额字段统一精度：BigDecimal scale(2, ROUND_HALF_UP)。

前端禁止上传金额格式为浮点类型（如 double），统一为字符串。

所有金额字段必须 ≥ 0，除非特殊字段明确支持负值（如调整记录）。


5. 审计日志
   所有资金变动写入审计表，包括：

操作人、时间、来源 IP、原始余额、变动金额、新余额

操作类型（手工/系统）

审计日志不可物理删除，只能追加



6. 风控规则建议
   限额：单笔、单日、单账户限额控制

黑名单账户拦截

异常频率检测（如连续失败交易）

地理位置变动敏感提示


7. 账户余额校验
   不仅余额 ≥ 0，还应校验：可用余额 ≥ 扣款金额

使用 availableAmount = total - frozen 公式统一计算

防止 “冻结资金” 被误操作成可扣



8. 数据库表设计规范
   所有资金变动必须有账务流水表 wallet_log，不可省略

加钱、扣钱都需要：

一个主单表（如 order）

一个流水表（如 wallet_log）


9. 异常与错误码规范
   所有资金操作类错误，应返回结构化错误码，如：

json
复制
编辑
{
"code": "BALANCE_NOT_ENOUGH",
"message": "余额不足"
}
明确区分系统异常和业务异常



10. 回滚与补偿机制
    必须使用数据库事务保证资金一致性

若调用外部接口（如通知其他系统），建议使用 可靠消息补偿机制（如 RabbitMQ + 状态表）

11. 系统性能与压力控制
    为防止并发雪崩：

接口加限流（如每秒最多 N 次）

使用 Redis 分布式锁保证一致性（特别是预下单场景）