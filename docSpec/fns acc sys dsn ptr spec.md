

核心金融系统中，为了保障交易安全、数据一致性、事务可靠性、并发控制和审计要求，往往会采用多种经典的系统设计模式和业务模型。以下是除了预先扣除冻结模式（如 TCC）和双账户模型（如借贷记账）的常见设计模式：

# ✅ 核心金融系统常见设计模式和模型
1. 预先冻结（冻结+确认）模式
   又称为：Try-Confirm-Cancel（TCC）模式

应用：支付、转账、限额控制

典型做法：先冻结资金，后确认或取消



# 3. 事件驱动架构（Event Sourcing + CQRS）
   所有操作生成事件（如“交易创建”“资金冻结”）

使用 事件日志 作为唯一数据源

支持审计、回滚、重放，提高系统可追溯性

CQRS 拆分读写，优化性能


# 4. 账本模型（多维度账本）
   将每个账户的不同维度（可用、冻结、在途、挂账）独立建模

支持多个子账户：如总账、明细账、子账户

可用于复杂清算、对账、风险控制等



# 6. 幂等机制 + 状态机模型
   所有操作必须幂等，支持多次请求不影响结果

使用交易状态机控制交易生命周期（如：创建 → 处理中 → 成功 / 失败）

应用在：支付系统、订单系统、退款流程等



# 7. 双写模式（同步缓存和数据库）
   写请求同时写入数据库和 Redis 缓存

用于高并发余额查询、交易明细

需解决：写一致性问题（



8. 批处理与对账模式
   日终、T+1 对账流程，生成报表、清算文件

用于和第三方机构对账（如支付网关、银联）

常见：流水对账、账实一致校验



, [5/13/2025 4:34 AM]
一、资金安全相关设计模式
# 1. 冻结账户 / 冻结余额
   前面提到的：分离“可用余额”和“冻结余额”来避免资源冲突和并发问题。

# 2. 双账户模型
   每个用户维护两个账户：

可用账户（主账户）：用户日常可用资金；

操作账户（交易账户）：用于高频交易、临时结算、风控管理；

内部转账快、可追踪；对外转账可设置多重控制。

, [5/13/2025 4:34 AM]
# . 账务流水不可变模型（Append-only Ledger）
所有资金变动记录不可更新、不可删除；

每次操作都新增一条流水（支持回滚也要新增记录）；

确保审计、安全、合规要求

, [5/13/2025 4:35 AM]
二、并发控制与一致性设计
# 4. TCC 模型（Try-Confirm-Cancel）    适用于分布式事务控制：

Try：冻结资源（如预扣余额）；

Confirm：确认并扣除；

Cancel：释放资源。

是分布式环境下冻结余额模式的升级版。

, [5/13/2025 4:35 AM]
# 5. 幂等操作设计（Idempotency Key）
   每个操作带唯一操作编号；

若重复调用同一编号，结果一致；

常用于防止用户多次点击支付、重发交易。

, [5/13/2025 4:36 AM]
三、系统稳定性与扩展性设计
# 6. 资金流水 + 账户快照双表结构
   流水表记录每一笔交易；

快照表保存每小时/每天的账户状态；

便于快速对账、还原历史状态。

账户快照表（Account Snapshot Table）虽然没有全球统一的“标准规范”，但在金融核心系统中是高度通用的设计模式，广泛应用于银行、证券、支付等领域。下面是行业通用设计规范和最佳实践，适用于核心账务系统的对账、审计、快照分析。

✅ 为什么要有账户快照表？
用于每日结息、账务核对（EOD 对账）

提供任意时点余额查询能力（如 T-1 日余额）

提升审计追踪能力（不可篡改的账务痕迹）

历史余额重建，供风控/统计使用

7. 账户锁定粒度控制
   对某笔交易加“事务锁”，而非锁整张表；

仅锁定资金变动账户，非目标账户。

, [5/13/2025 4:36 AM]
# 异步补偿机制
若转账失败，但已冻结，系统自动重试或人工介入；

常配合消息队列（MQ）和事务表。

, [5/13/2025 4:37 AM]
# 四、风控与合规设计
.. 9. 多级权限与审批机制
   大额转账、多次失败、敏感操作需审批；

人机结合增强风控。

..10. 资金验证机制
    冻结后等待验证码或指令确认；

确保用户真实意图，防止误操作或盗刷。

 
五、业务灵活性设计
11. 虚拟账户体系（子账户）
    用户账户下可建立多个“虚拟子账户”：

用于理财、红包、押金、奖金等；

各自独立、可结算、方便隔离。

12. 交易通道分流 + 清结算分离
    不同通道（银行卡、微信、支付宝）走不同逻辑；

“交易”与“结算”分离，支持 T+1 等结算周期。


# 金融事件列表



所有操作生成事件（如“交易创建”“资金冻结”）   ，金融系统一般有哪些事件，可有标准规范吗，


ChatGPT 说：
金融系统中的“事件”设计，是支撑分布式架构、异步通信、审计追溯、风控监测的核心机制。虽然没有统一的国际标准明确定义“金融事件列表”，但大多数中大型金融机构（银行、第三方支付、券商）会根据金融业务流程、交易生命周期、监管需求自行定义一套标准事件体系。以下是行业普遍采用的通用分类与示例。

✅ 一、常见金融事件分类（事件域）
事件域	常见事件（Event）关键词
账户类	账户创建、账户冻结、账户解冻、账户变更、账户注销
资金类	资金冻结、资金解冻、资金划拨、余额变更、提现、充值
交易类	交易发起、交易确认、交易成功、交易失败、交易取消、退款
风控类	风控命中、限额触发、黑名单校验、地理异常、IP 异常
清结算类	对账启动、对账成功、结算完成、清算差异、清算回滚
通知类	账变通知、到账通知、短信通知、催收通知、消息推送
授权类	身份验证成功/失败、OTP 校验、授权通过、授权撤销
审计/合规类	数据访问、敏感字段修改、权限变更、登录登出、风险行为记录



举个例子：支付流程中的事件链
text
复制
编辑
用户发起支付 → 交易创建 (txn.create)
↓
风控检查 (risk.checked)
↓
资金冻结 (funds.frozen)
↓
支付网关处理 (payment.initiated)
↓
支付成功 (txn.success) 或 失败 (txn.failed)
↓
资金解冻 / 扣款完成 (funds.debited)
↓
通知业务系统 (notify.sent)


厂家金融规范

三、事件标准参考（行业实践）
虽然没有一个全球统一的事件标准库，但以下几个行业标准可供参考：

参考来源	简介说明
ISO 20022	金融报文与交易数据标准，提供统一语义（如支付、证券、卡交易）
FIX 协议	金融信息交换协议，广泛用于证券、衍生品等系统
OpenBanking API 事件规范	某些国家（如英国、澳大利亚）定义标准化金融事件，如账户变更、交易通知等
银行间清算系统（如 SWIFT）	有详细的交易、对账、状态变更事件消息



✅ 一、Open Banking API 的事件规范（Event Notification Standards）
Open Banking API，尤其在英国（Open Banking UK）、欧洲（PSD2）、澳大利亚（CDR）等区域，推行了标准化事件机制，主要目标是：

“允许银行（数据持有者）主动通知第三方服务商（TPP）关于账户、交易、授权等重要状态变化。”

📘 常见事件类型（以英国 Open Banking 为例）
事件类别	示例事件	说明
账户事件	AccountCreated, AccountUpdated	用户新增或变更银行账户
交易事件	TransactionPosted	新交易入账或状态变化
支付事件	PaymentSubmitted, PaymentFailed, PaymentCompleted	即时支付相关事件
授权事件	ConsentGranted, ConsentRevoked	用户授权第三方或撤销
错误事件	APIError, RateLimitExceeded	调用异常、配额限制

📦 标准格式
Open Banking UK 和澳洲 CDR 通常使用如下字段设计事件：

json
复制
编辑
{
"event_id": "abc123",
"event_time": "2025-05-13T10:15:30Z",
"event_type": "TransactionPosted",
"subject": {
"account_id": "98765",
"transaction_id": "TX123456"
},
"source": "bank-api.openbanking.com",
"data": { ... }
}